---
title: "The CCISS Tool"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    logo: www/logo.svg
    favicon: www/favicon.ico
    #css: www/style.css
    theme:
      version: 4
      bootswatch: yeti
      primary: "#003366"
runtime: shiny_prerendered
#     theme : yeti
# runtime: shiny
---

```{r setup, include=FALSE, context="setup"}
suppressPackageStartupMessages({
  library(ccissdev)
  library(shiny)
  library(leaflet)
  library(DT)
  library(RPostgres)
  library(plotly)
  library(pool)
  library(ggplot2)
  library(ggthemes)
  library(rAmCharts4)
  library(kableExtra)
  library(rhandsontable)
  library(shinyBS)
  library(colourvalues)
})
```

```{r server-start, include=FALSE, context="server-start"}
pool <- dbPool(
  drv = RPostgres::Postgres(),
  dbname = Sys.getenv("BCGOV_DB"),
  host = Sys.getenv("BCGOV_HOST"),
  port = 5432, 
  user = Sys.getenv("BCGOV_USR"),
  password = Sys.getenv("BCGOV_PWD")
)
onStop(function() {
  poolClose(pool)
})
# ##bybec db connection
# sppDb <- dbPool(
#   drv = RPostgres::Postgres(),
#   dbname = "spp_feas",
#   host = "138.197.168.220",
#   port = 5432, 
#   user = "postgres",
#   password = "PowerOfBEC"
# )
# onStop(function() {
#   poolClose(sppDb)
# })
poolclim <- dbPool(
    drv = RPostgres::Postgres(),
    dbname = "bgc_climate_data",
    host = Sys.getenv("BCGOV_HOST"),
    port = 5432, 
    user = Sys.getenv("BCGOV_USR"),
    password = Sys.getenv("BCGOV_PWD")
  )
  onStop(function() {
    poolClose(poolclim)
  })
  
##save this as package data
cfrg_rules <- fread("../PreferredAcceptibleRules.csv")
cfrg_rules <- melt(cfrg_rules,id.vars = "Spp",variable.name = "Feasible",value.name = "PrefAcc")
cfrg_rules[,Feasible := as.character(gsub("E","",Feasible))]
###
bcgov_tileserver <- Sys.getenv("BCGOV_TILESERVER")
bcgov_tilelayer <- Sys.getenv("BCGOV_TILELAYER")
district_tileserver <- "https://tileserver.thebeczone.ca/data/Districts/{z}/{x}/{y}.pbf"
district_tilelayer <- "Districts"
if (is.null(bcgov_tileserver) || is.null(bcgov_tilelayer)) stop("tileserver env not set")
mbtk <- Sys.getenv("BCGOV_MAPBOX_TOKEN")
mblbstyle <- Sys.getenv("BCGOV_MAPBOX_LABELS_STYLE")
mbhsstyle <- Sys.getenv("BCGOV_MAPBOX_HILLSHADE_STYLE")
source("./server/LeafletSource.R")

### create parameter input charts
gcm_weight <- data.table(gcm = c("ACCESS-ESM1-5", "BCC-CSM2-MR", "CanESM5", "CNRM-ESM2-1", "EC-Earth3", 
"GFDL-ESM4", "GISS-E2-1-G", "INM-CM5-0", "IPSL-CM6A-LR", "MIROC6", 
"MPI-ESM1-2-HR", "MRI-ESM2-0", "UKESM1-0-LL"),
                         weight = c(1,1,0,1,1,1,1,0,1,1,1,1,0))

rcp_weight <- data.table(rcp = c("ssp126","ssp245","ssp370","ssp585"), 
                         weight = c(0.8,1,0.8,0))

all_weight <- as.data.table(expand.grid(gcm = gcm_weight$gcm,rcp = rcp_weight$rcp))
all_weight[gcm_weight,wgcm := i.weight, on = "gcm"]
all_weight[rcp_weight,wrcp := i.weight, on = "rcp"]
all_weight[,weight := wgcm*wrcp]
```

<script>
$("body").on("shown.bs.tab", "a[data-toggle='tab']", function(e) {
   Shiny.setInputValue("active_tab", $(e.target).parent().index());
})
</script>

SELECT SITES
=====================================

Inputs {.sidebar data-width=450}
-------------------------------------

```{r}
wellPanel(
  splitLayout(
    actionButton("sesh_params","Adjust Parameters",icon = icon("sliders-h")),

radioButtons(
      "aggregation",
      "Multiple Point Aggregation:",
      c("Individual" = "FALSE", "Averaged by BGC Subzone" = "TRUE"),
      selected = "TRUE"
    )
  ),
style = "padding: 5px 5px 5px 5px; margin:0%"
)
hr(style = "border-top: 1px solid #8f0e7e;")
```


##### Add Points Using One of the 3 Methods Below

###### 1. Enter Lat/Long or Click on Map to Add Points
Click on the map to add points or use 'Enter New' to manually add a specific lat/long coordinate 
```{r}
# Points
DT::DTOutput("points_table", width="100%")

actionButton("add_dialog", "Enter New", icon("plus"), width=120)
actionButton("delete_button", "Selected", icon("trash-alt"), width=120)
actionButton("clear_button", "Clear All", icon("broom"), width=120)
hr(style = "border-top: 1px solid #8f0e7e;")
```


###### 2. Generate summary using preselected points by BGC or BGC+Distict:

Click BGC on map to use points across an entire BGC subzone/variant or only BGCs within a Forest District
```{r}
splitLayout(
  radioButtons(
      "preselected",
      label = NULL,
      choiceNames =  c("None", "BGC","District then BGC"),
      choiceValues = c("N","BGC","BGC_Dist"),
      inline = T
    ),
  actionButton("clear_highlight","Clear Selections"),
  cellWidths = c("67%", "33%")
)
  
textOutput("bgc_click_show")
textOutput("dist_click_show")

hr(style = "border-top: 1px solid #8f0e7e;")
```

###### 3. Upload a CSV file contain points of interests

Upload a csv file with columns named ID1, Latitude, and Longitude (negative values) with your points of interest.


```{r}
# Actions on points
actionButton("upload_button", "Upload CSV", icon("upload"), 
             style = "width:100%; background-color:#8f0e7e; color: #FFF")
hr(style = "border-top: 1px solid #8f0e7e;")
```

---

```{r}
actionButton("clear_selections","Clear Selections",
             style = "width:100%; background-color:#c21104; color: #FFF")
hr(style = "border-top: 1px solid #8f0e7e;")
```

##### Ready to Go!

```{r}

# Generate results
actionButton("generate_results", label = "Generate results", icon = icon("plus-square"),
             style = "width:100%; background-color:#003366; color: #FFF")

```



Biogeoclimatic Zones + Subzones Variants Map
-------------------------------------

```{r}
leafletOutput("bec_map", height = "auto")
# bsModal("instr_modal",title = NULL,"show_instr", size = "large",
#         uiOutput("modal_ui")
#         )
```

FEASIBILITY REPORT
=====================================  

Inputs {.sidebar data-width=230}
-------------------------------------

###### Filters  

```{r}
selectInput("siteref_feas", label = "Sites:", choices = character())
selectInput("site_series_feas", label = "Site Series", choices = character())
selectInput("filter_feas", label = "Feasibility", choices = c("All" = "a", "Feasible Only" = "f"))
```

###### Legend
```{r}
HTML(
  paste0(
    '<svg viewBox="0 0 1 1" height="14px" width="14px"><rect height=1 width=1 style="fill : ',
    c("limegreen", "deepskyblue", "gold", "grey"),
    '" /><span style="vertical-align:middle">&nbsp;',
    c("Primary", "Secondary", "Tertiary", "Not Suitable"),
    '</span>',
    collapse = "<br />"
  )
)
```

CCISS Report
-------------------------------------

```{r}
column(12, align="center", tableOutput("results_feas"))
```

Graphical {data-navmenu="BEC FUTURES"}
=====================================

Inputs {.sidebar data-width=230}
-------------------------------------

###### Filter

```{r}
selectInput("siteref_bgc_fut", label = "Sites:", choices = character())
selectInput("ss_bgc_fut",label = "Site Series:", choices = character())
sliderInput("min_ssoverlap",label = "Min Site Series Overlap", min = 0.05,max = 0.25,value = 0.1)
```

BEC Futures: ratio of predicted BGC with aligned site series from all selected climate model/scenarios
-------------------------------------

### Ratio of Model Predictions of future BGCs and aligned site series `r textOutput("current_bgc_fut", inline = TRUE)`

```{r}
plotly::plotlyOutput("bgc_fut_plot", width = "100%", height = "auto")
```


Spatial {data-navmenu="BEC FUTURES"}
=====================================

Inputs {.sidebar data-width=230}
-------------------------------------

###### Filter

```{r}
selectInput("siteref_bgc_fut_spatial", label = "Sites:", choices = character())
selectInput("bgc_spatial_period",label = "Period:",choices = c("Choose Period" = "", "Current" = 1991,"2021-2040" = 2021, "2041-2060" = 2041, "2061-2080" = 2061, "2081-2100" = 2081))
```

BEC Futures: Map of all predicted BGCs
-------------------------------------

```{r}
leafletOutput("wna_map", height = "auto")
```


SILVICS & ECOLOGY
=====================================     

Inputs {.sidebar data-width=230}
-------------------------------------

###### Filters  

```{r}
selectInput("siteref_silv", label = "Sites:", choices = character())
selectInput("site_series_silv", label = "Site Series", choices = character())
selectInput("filter_silv", label = "Tree Species", choices = c("Feasible Species" = "f", "All Species" = "a"))
```

Silvics & Ecology {.tabset}
-------------------------------------

### Chief Forester Reference Guide

```{r}
uiOutput("silviculture_block")
```

### Tolerance

```{r}
tableOutput("silvics_tol_dt")
```

### Resistance

```{r}
tableOutput("silvics_resist_dt")
```

### Regeneration stage

```{r}
tableOutput("silvics_regen_dt")
```

### Maturing stage

```{r}
tableOutput("silvics_mature_dt")
```

SPECIES PORTFOLIO *Draft* {data-orientation=columns}
=====================================

Inputs {.sidebar data-width=300}
-------------------------------------

###### Data Options

```{r}
selectInput("port_bgc",label = "Select BGC:", choices = character())
radioButtons("port_ss",label = "Select Site Postion:",choices = c("B2","Zonal","D6"), selected = "Zonal")
treeOpts <- c("Py","Fd","At","Pl","Sx","Bl","Cw","Hw","Pw","Ss","Lw","Ba","Hm","Dr","Mb")
selectInput("tree_species",label = "Included Species:", choices = treeOpts, selected = treeOpts, multiple = T)
radioButtons("port_length",label = "Optimisation Period (Rotation Length):",
             choiceNames = c("Current Period","20 Year","40 Year","60 Year","80 Year"),
             choiceValues = c(1991,2021,2041,2061,2081),selected = 2081)
# radioButtons(
#     "fut_scn",
#     "RCP Scenario:",
#     selected = "ssp370",
#     c("2.6 W/m2" = "ssp126", "4.5 W/m2" = "ssp245", "7.0 W/m2" = "ssp370", "8.5 W/m2" = "ssp585"),
#     
#   )
```

###### Portfolio Parameters

```{r}
rHandsontableOutput("setbounds")
sliderInput("return_level","Specified Return:", min = 0.5, max = 1,value = 0.9)
sliderInput("min_accept","Minimum allowed weight:",min = 0.01,max = 0.2,value = 0.05)
actionButton("generate_portfolio", label = "Run Portfolio", icon = icon("plus-square"),
             style = "width:100%; background-color:#003366; color: #FFF")
```


Row
-------------------------------------

### Efficient Frontier

```{r}
plotOutput("efficient_frontier", width = "100%", height = "auto")
```

### Growth Simulations

```{r}
plotOutput("growth_sim",  width = "100%", height = "auto")
```

Row
-------------------------------------

### Optimised Weights

```{r}
tableOutput("port_table")
```

### Site Index and Feasibility

```{r}
DTOutput("port_sssum")
```

EXPORT
=====================================

Inputs {.sidebar data-width=420}
-------------------------------------

###### Filter

```{r}
selectInput("report_filter_feas", label = "Tree Species", choices = c("All" = "a", "Feasible Only" = "f"))
actionButton("report_filter_all", label = "Check All", icon = icon("check"))
actionButton("report_filter_none", label = "Uncheck All", icon = icon("ban"))
div(
  checkboxGroupInput("report_filter", label = "Site Series", choices = character(), width = 400),
  style = "line-height: 1.5; color: #222; background-color: #fff; margin: 10px 0px 10px 0px; padding: 0px 10px 0px 10px"
)
```

Export a Digital Report or Dataset for Analyzed Sites
-------------------------------------

### Export a report on selected points

```{r}
dl_style <- "max-width: 300px; width:100%; height: 40px !important;"
splitLayout(
  div(
    textInput("report_name", "Name for Report", value = "report"),
    radioButtons("report_format", "Report Format", c("html","pdf"), inline = TRUE), ##temporarily removed pdf option
    span(downloadButton("report_download", "Produce Report", style = dl_style), id = "download_report_span")
  ),
  div(
    radioButtons("data_format", "Data Format", c("csv", "rds"), inline = TRUE),
    span(downloadButton("data_download", "Download Data", style = dl_style), id = "download_data_span")
  ) 
)

```

How the CCISS tool works {data-navmenu="TECH SPECS"} 
=====================================

The Climate Change Informed Species Selection Tool provides information on future tree species suitability in British Columbia. It combines future climate information with species viability models to illustrate how likely each species is to thrive in the range of potential futures.  

The CCISS tool reassesses the suitability ranks of species at a site series level under multiple plausible modelled future climates. Understanding climate- and site-level species suitability is one of the foundational pieces of information that a forester requires for the creation of successful silvicultural prescriptions over a rotation. The CCISS tool looks at near- and mid-term projected changes to BGC climates and the implications to species suitability. The tool then aligns the projected future suitability rank of species at a POI with the suitability in the default stocking standards outlined in the Chief Foresterâ€™s Reference Guide to highlight where there are predicted climate change induced shifts in species suitability. This information can be used to inform planting/ silvicultural prescription outlined in climate change informed stocking standard. The CCISS tool is spatial explicit to account for the gradient of climate change that will different regions and elevations of a BGC.  
  
[Would you like to know more?](https://www.for.gov.bc.ca/ftp/HRE/external/!publish/CCISS/CCISS_in_Stocking%20Standards.pdf)

Model information {data-navmenu="TECH SPECS"}
=====================================

### Current versions of Information Tables, Maps, and Models used in this App

```{r}
div(
  tableOutput("modelsinfo"),
  plotly::plotlyOutput("timings", width = "100%")
)
```

Shiny App Information {data-navmenu="TECH SPECS"} 
=====================================

```{r}
tableOutput("shinyinfo")
```

INSTRUCTIONS
=====================================

##### What is CCISS?

Here's some pithy text about CCISS.

##### How do I use the tool?

More pithy and instructive text. 

```{r}
tags$script(HTML('
  Shiny.addCustomMessageHandler("jsCode",
    function(message) {
      console.log(message)
      eval(message.code);
    }
  );'
))

# tags$script(HTML(
#   jscode_bgc
# ))

```

```{r server, context = "server"}
# bslib::bs_themer()
# Reusing Shiny session userData environment
uData <- session$userData
portfolio_results <- reactiveValues(data = NULL)
session_params <- reactiveValues(estabWt = c(0.3,0.35,0.35),futWt = c(0.25,0.25,0.25,0.25),
                             modelWt = all_weight, rcpWt = rcp_weight, gcmWt = gcm_weight)
update_flag <- reactiveVal(0)
selected_site <- reactiveValues(siteref = NULL, ss = NULL)

source("./server/generate.R", local = TRUE)
source("./server/points.R", local = TRUE)
source("./server/map.R", local = TRUE)
source("./server/feasibility.R", local = TRUE)
source("./server/silviculture.R", local = TRUE)
source("./server/futures.R", local = TRUE)
source("./server/download.R", local = TRUE)
source("./server/generate_portfolio.R", local = TRUE)

##hover text for feasibility report
hoverText <- c("Species","Time Period","Percentage of models preciting each feasibility",
                 "Chief Forester's reference guide","Environmental Feasibility",
                 "Modelled Establishment feasibility (based on historic,current, and near-future)",
                 "Modelled future feasibility (based on all four future periods)","Model Trends")
##show instructions
# output$modal_ui <- renderUI({
#   HTML(readLines(rmarkdown::render("./server/CCISS_Instructions.Rmd",encoding = "UTF-8",envir = new.env()),encoding = "UTF-8"))
# })

uData$bec_click_flag <- FALSE
##default session parameters
output$rcp_select <- renderAmChart4({
  amBarChart(
    data = session_params$rcpWt,
    category = "rcp", values = "weight",
    draggable = TRUE,
    tooltip =
      "[bold]{valueY}[/]",
    xAxis = list(title = amText(text = "Scenario")),
    yAxis = list(
      title = amText(text = "Weight", color = "maroon"),
      labels = amAxisLabels(fontSize = 10),
      gridLines = amLine(color = "orange", width = 1, opacity = 0.4)
    ),
    yLimits = c(0, 1),
    valueFormatter = "#.##",
    theme = "dataviz")
})
output$gcm_select <- renderAmChart4({
  amBarChart(
    data = session_params$gcmWt,
    category = "gcm", values = "weight",
    draggable = TRUE,
    columnWidth = 80,
    tooltip =
      "[bold]{valueY}[/]",
    xAxis = list(title = amText(text = "GCM"),
                 labels = amAxisLabels(fontSize = 10,rotation = 90)),
    yAxis = list(
      title = amText(text = "Weight", color = "maroon"),
      labels = amAxisLabels(fontSize = 10),
      gridLines = amLine(color = "orange", width = 1, opacity = 0.4)
    ),
    yLimits = c(0, 1),
    valueFormatter = "#.##",
    theme = "dataviz")
})

observeEvent(input$sesh_params,{
  showModal(modalDialog(
    h2("Adjust Session Parameters"),
    # Control results
    
    h6("Establishment Feasibility Weights"),
    splitLayout(
      numericInput("hwt961","1961-1990", value = session_params$estabWt[1], min = 0, max = 1,step = 0.05),
      numericInput("hwt991","1991-2020", value = session_params$estabWt[2], min = 0, max = 1,step = 0.05),
      numericInput("hwt21","2021-2040", value = session_params$estabWt[3], min = 0, max = 1,step = 0.05)
    ),
    h6("Future Period Weights"),
    splitLayout(
      numericInput("wt21","2021-2040", value = session_params$futWt[1], min = 0, max = 1,step = 0.05),
      numericInput("wt41","2041-2060", value = session_params$futWt[2], min = 0, max = 1,step = 0.05),
      numericInput("wt61","2061-2080", value = session_params$futWt[3], min = 0, max = 1,step = 0.05),
      numericInput("wt81","2081-2100", value = session_params$futWt[4], min = 0, max = 1,step = 0.05)
    ),
    h6("GCM Weights"),
    p("Click and drag bars to adjust weights"),
    amChart4Output("gcm_select",width = "790px"),
    h6("Scenario Weights"),
    amChart4Output("rcp_select"),
    footer = tagList(
      modalButton("Cancel"),
      actionButton("adj_params","OK!",
                   style = "background-color:#1d8f0e; color: #FFF")
    ),
    size = "l"
    ))
})

observeEvent(input$adj_params,{
  estabWt <- as.numeric(c(input$hwt961,input$hwt991,input$hwt21))
  estabWt <- estabWt/sum(estabWt)
  futWt <- as.numeric(c(input$wt21,input$wt41,input$wt61,input$wt81))
  futWt <- futWt/sum(futWt)
  
  gcm_weight <- as.data.table(input$gcm_select)
  setnames(gcm_weight,c("gcm","weight"))
  rcp_weight <- as.data.table(input$rcp_select)
  setnames(rcp_weight,c("rcp","weight"))
  all_weight <- as.data.table(expand.grid(gcm = gcm_weight$gcm,rcp = rcp_weight$rcp))
  all_weight[gcm_weight,wgcm := i.weight, on = "gcm"]
  all_weight[rcp_weight,wrcp := i.weight, on = "rcp"]
  all_weight[,weight := wgcm*wrcp]
  session_params$estabWt <- estabWt
  session_params$futWt <- futWt; session_params$modelWt <- all_weight;
  session_params$rcpWt <- rcp_weight; session_params$gcmWt <- gcm_weight
  session$sendCustomMessage(type="jsCode", list(code= "$('#generate_results').prop('disabled', false)"))
  removeModal()
})

output$shinyinfo <- function() {
  app_info <- data.table(
    Information = c("Shiny host","Tiles source","Tileserver","Github","Copyright","License"),
    Value = c(system("hostname", intern = TRUE), Sys.getenv("BCGOV_TILESERVER"),
              strsplit(Sys.getenv("BCGOV_TILESERVER"), split = "data")[[1]][1],
              as.character(tags$a(href = "https://github.com/bcgov/CCISS_ShinyApp", "bcgov/CCISS_ShinyApp")),
              paste(format(Sys.Date(), "%Y"), "Province of British Columbia"),
              as.character(tags$a(href = "http://www.apache.org/licenses/LICENSE-2.0", "Apache 2.0 LICENSE")))
  )
  knitr::kable(app_info, format = "html", table.attr = 'class="table table-hover table-centered"', escape = FALSE)
}
```
