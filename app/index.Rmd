---
title: "The Climate Change Informed Species Selection Tool: v12"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    logo: www/logo.svg
    favicon: www/favicon.ico
    #css: www/style.css
    theme:
      version: 4
      bootswatch: yeti
      primary: "#003366"
runtime: shiny_prerendered
#     theme : yeti
# runtime: shiny
---

```{r global, include=FALSE}
suppressPackageStartupMessages({
  library(ccissdev)
  library(shiny)
  library(leaflet)
  library(DT)
  library(RPostgres)
  library(plotly)
  library(pool)
  library(ggplot2)
  library(ggthemes)
  library(rAmCharts4)
  library(kableExtra)
  library(rhandsontable)
})
pool <- dbPool(
  drv = RPostgres::Postgres(),
  dbname = Sys.getenv("BCGOV_DB"),
  host = Sys.getenv("BCGOV_HOST"),
  port = 5432, 
  user = Sys.getenv("BCGOV_USR"),
  password = Sys.getenv("BCGOV_PWD")
)
onStop(function() {
  poolClose(pool)
})
poolclim <- dbPool(
    drv = RPostgres::Postgres(),
    dbname = "bgc_climate_data",
    host = Sys.getenv("BCGOV_HOST"),
    port = 5432, 
    user = Sys.getenv("BCGOV_USR"),
    password = Sys.getenv("BCGOV_PWD")
  )
  onStop(function() {
    poolClose(poolclim)
  })
bcgov_tileserver <- Sys.getenv("BCGOV_TILESERVER")
bcgov_tilelayer <- Sys.getenv("BCGOV_TILELAYER")
if (is.null(bcgov_tileserver) || is.null(bcgov_tilelayer)) stop("tileserver env not set")
mbtk <- Sys.getenv("BCGOV_MAPBOX_TOKEN")
mblbstyle <- Sys.getenv("BCGOV_MAPBOX_LABELS_STYLE")
mbhsstyle <- Sys.getenv("BCGOV_MAPBOX_HILLSHADE_STYLE")

### create parameter input charts
gcm_weight <- data.table(gcm = c("ACCESS-ESM1-5", "BCC-CSM2-MR", "CanESM5", "CNRM-ESM2-1", "EC-Earth3", 
"GFDL-ESM4", "GISS-E2-1-G", "INM-CM5-0", "IPSL-CM6A-LR", "MIROC6", 
"MPI-ESM1-2-HR", "MRI-ESM2-0", "UKESM1-0-LL"),
                         weight = c(1,1,0,1,1,1,1,0,1,1,1,1,0))

rcp_weight <- data.table(rcp = c("ssp126","ssp245","ssp370","ssp585"), 
                         weight = c(0.8,1,0.8,0))

all_weight <- as.data.table(expand.grid(gcm = gcm_weight$gcm,rcp = rcp_weight$rcp))
all_weight[gcm_weight,wgcm := i.weight, on = "gcm"]
all_weight[rcp_weight,wrcp := i.weight, on = "rcp"]
all_weight[,weight := wgcm*wrcp]
```

SELECT SITES
=====================================

Inputs {.sidebar data-width=550}
-------------------------------------

###### Points of interest

```{r}
# Actions on points
actionButton("upload_button", "Upload CSV", icon("upload"), width=120)
actionButton("add_dialog", "Enter New", icon("plus"), width=120)
actionButton("delete_button", "Selected", icon("trash-alt"), width=120)
actionButton("clear_button", "Clear All", icon("broom"), width=120)

# Points
DT::DTOutput("points_table", width="100%")

# Control results
radioButtons(
  "aggregation",
  "Multiple Point Aggregation:",
  c("Individual" = "FALSE", "Averaged by BGC Subzone" = "TRUE"),
  selected = "TRUE"
)

actionButton("sesh_params","Adjust Session Parameters",icon = icon("sliders-h"),
             style = "width:100%; background-color:#8f0e7e; color: #FFF")
# Generate results
actionButton("generate_results", label = "Generate results", icon = icon("plus-square"),
             style = "width:100%; background-color:#003366; color: #FFF")

```

###### Instructions
Click on the map or use table to add points.  
To edit cells, double click a row.  
Hit Ctrl+Enter to submit new values.

Biogeoclimatic Zones + Subzones Variants Map
-------------------------------------
```{r}
leafletOutput("bec_map", height = "auto")
```

FEASIBILITY REPORT
=====================================  

Inputs {.sidebar data-width=230}
-------------------------------------

###### Filters  

```{r}
selectInput("siteref_feas", label = "Sites:", choices = character())
selectInput("site_series_feas", label = "Site Series", choices = character())
selectInput("filter_feas", label = "Feasibility", choices = c("All" = "a", "Feasible Only" = "f"))
```

###### Legend
```{r}
HTML(
  paste0(
    '<svg viewBox="0 0 1 1" height="14px" width="14px"><rect height=1 width=1 style="fill : ',
    c("limegreen", "deepskyblue", "gold", "grey"),
    '" /><span style="vertical-align:middle">&nbsp;',
    c("Primary", "Secondary", "Tertiary", "Not Suitable"),
    '</span>',
    collapse = "<br />"
  )
)
```

Tree Feasibility Ratings{.tabset}
-------------------------------------

### Summary Results

```{r}
tableOutput("results_feas")
```

### Detail Results

```{r}
tableOutput("summary_feas")
```

   
SILVICULTURE INFO
=====================================     

Inputs {.sidebar data-width=230}
-------------------------------------

###### Filters  

```{r}
selectInput("siteref_silv", label = "Sites:", choices = character())
selectInput("site_series_silv", label = "Site Series", choices = character())
selectInput("filter_silv", label = "Tree Species", choices = c("Feasible Species" = "f", "All Species" = "a"))
```

Silvics & Ecology {.tabset}
-------------------------------------

### Chief Forester Reference Guide

```{r}
uiOutput("silviculture_block")
```

### Tolerance

```{r}
tableOutput("silvics_tol_dt")
```

### Resistance

```{r}
tableOutput("silvics_resist_dt")
```

### Regeneration stage

```{r}
tableOutput("silvics_regen_dt")
```

### Maturing stage

```{r}
tableOutput("silvics_mature_dt")
```

BGC FUTURES
=====================================

Inputs {.sidebar data-width=230}
-------------------------------------

###### Filter

```{r}
selectInput("siteref_bgc_fut", label = "Sites:", choices = character())
selectInput("ss_bgc_fut",label = "Site Series:", choices = character())
sliderInput("min_ssoverlap",label = "Min Site Series Overlap", min = 0.05,max = 0.25,value = 0.1)
```

BGC Futures: ratio of future models predicting BGC
-------------------------------------

### Ratio of Models Predicting BGC `r textOutput("current_bgc_fut", inline = TRUE)`

```{r}
plotly::plotlyOutput("bgc_fut_plot", width = "100%", height = "auto")
```

SPECIES PORTFOLIO {data-orientation=columns}
=====================================

Inputs {.sidebar data-width=300}
-------------------------------------

###### Data Options

```{r}
selectInput("port_bgc",label = "Select BGC:", choices = character())
radioButtons("port_ss",label = "Select Site Postion:",choices = c("B2","Zonal","D6"), selected = "Zonal")
treeOpts <- c("Py","Fd","At","Pl","Sx","Bl","Cw","Hw","Pw","Ss","Lw","Ba","Hm","Dr","Mb")
selectInput("tree_species",label = "Included Species:", choices = treeOpts, selected = treeOpts, multiple = T)
radioButtons("port_length",label = "Optimisation Period (Rotation Length):",
             choiceNames = c("Current Period","20 Year","40 Year","60 Year","80 Year"),
             choiceValues = c(1991,2021,2041,2061,2081))
# radioButtons(
#     "fut_scn",
#     "RCP Scenario:",
#     selected = "ssp370",
#     c("2.6 W/m2" = "ssp126", "4.5 W/m2" = "ssp245", "7.0 W/m2" = "ssp370", "8.5 W/m2" = "ssp585"),
#     
#   )
```

###### Portfolio Parameters

```{r}
rHandsontableOutput("setbounds")
sliderInput("return_level","Specified Return:", min = 0.5, max = 1,value = 0.9)
sliderInput("min_accept","Minimum allowed weight:",min = 0.01,max = 0.2,value = 0.05)
sliderInput("prob_pest","Probability of Pest Outbreak:", min = 0, max = 0.1, value = 0.02)
actionButton("generate_portfolio", label = "Run Portfolio", icon = icon("plus-square"),
             style = "width:100%; background-color:#003366; color: #FFF")
sliderInput("sim_group", "Select Simulation to Plot: ", min = 1, max = 25, value = 1, step = 1)
```


Row
-------------------------------------

### Efficient Frontier

```{r}
plotOutput("efficient_frontier", width = "100%", height = "auto")
```

### Growth Simulations

```{r}
plotOutput("growth_sim",  width = "100%", height = "auto")
```

Row
-------------------------------------

### Optimised Weights

```{r}
tableOutput("port_table")
```

### Site Index and Feasibility

```{r}
DTOutput("port_sssum")
```

EXPORT
=====================================

Inputs {.sidebar data-width=420}
-------------------------------------

###### Filter

```{r}
selectInput("report_filter_feas", label = "Tree Species", choices = c("All" = "a", "Feasible Only" = "f"))
actionButton("report_filter_all", label = "Check All", icon = icon("check"))
actionButton("report_filter_none", label = "Uncheck All", icon = icon("ban"))
div(
  checkboxGroupInput("report_filter", label = "Site Series", choices = character(), width = 400),
  style = "line-height: 1.5; color: #222; background-color: #fff; margin: 10px 0px 10px 0px; padding: 0px 10px 0px 10px"
)
```

Export a Digital Report or Dataset for Analyzed Sites
-------------------------------------

### Export a report on selected points

```{r}
dl_style <- "max-width: 300px; width:100%; height: 40px !important;"
splitLayout(
  div(
    textInput("report_name", "Name for Report", value = "report"),
    radioButtons("report_format", "Report Format", c("html", "pdf"), inline = TRUE),
    span(downloadButton("report_download", "Produce Report", style = dl_style), id = "download_report_span")
  ),
  div(
    radioButtons("data_format", "Data Format", c("csv", "rds"), inline = TRUE),
    span(downloadButton("data_download", "Download Data", style = dl_style), id = "download_data_span")
  ) 
)

```

How the CCISS tool works {data-navmenu="ABOUT"} 
=====================================

The Climate Change Informed Species Selection Tool provides information on future tree species suitability in British Columbia. It combines future climate information with species viability models to illustrate how likely each species is to thrive in the range of potential futures.  

The CCISS tool reassesses the suitability ranks of species at a site series level under multiple plausible modelled future climates. Understanding climate- and site-level species suitability is one of the foundational pieces of information that a forester requires for the creation of successful silvicultural prescriptions over a rotation. The CCISS tool looks at near- and mid-term projected changes to BGC climates and the implications to species suitability. The tool then aligns the projected future suitability rank of species at a POI with the suitability in the default stocking standards outlined in the Chief Forester’s Reference Guide to highlight where there are predicted climate change induced shifts in species suitability. This information can be used to inform planting/ silvicultural prescription outlined in climate change informed stocking standard. The CCISS tool is spatial explicit to account for the gradient of climate change that will different regions and elevations of a BGC.  
  
[Would you like to know more?](https://www.for.gov.bc.ca/ftp/HRE/external/!publish/CCISS/CCISS_in_Stocking%20Standards.pdf)

Model information {data-navmenu="ABOUT"}
=====================================

### Current versions of Information Tables, Maps, and Models used in this App

```{r}
div(
  tableOutput("modelsinfo"),
  plotly::plotlyOutput("timings", width = "100%")
)
```

Shiny App Information {data-navmenu="ABOUT"} 
=====================================

```{r}
tableOutput("shinyinfo")
```

```{r}
tags$script(HTML('
  Shiny.addCustomMessageHandler("jsCode",
    function(message) {
      console.log(message)
      eval(message.code);
    }
  );'
))

```

```{r server, context = "server"}
# bslib::bs_themer()
# Reusing Shiny session userData environment
uData <- session$userData

library(sf)
tOut <- st_read("./TileOutline.gpkg")
tOut2 <- st_read("./RCB_Outline.gpkg")
tOut <- st_union(tOut,tOut2)
portfolio_results <- reactiveValues(data = NULL)
session_params <- reactiveValues(estabWt = c(0.3,0.35,0.35),midWt = c(0.5,0.5),
                             modelWt = all_weight, rcpWt = rcp_weight, gcmWt = gcm_weight)
update_flag <- reactiveVal(0)
source("./server/generate.R", local = TRUE)
source("./server/points.R", local = TRUE)
source("./server/map.R", local = TRUE)
source("./server/feasibility.R", local = TRUE)
source("./server/silviculture.R", local = TRUE)
source("./server/futures.R", local = TRUE)
source("./server/download.R", local = TRUE)
source("./server/generate_portfolio.R", local = TRUE)

##default session parameters
output$rcp_select <- renderAmChart4({
  amBarChart(
    data = session_params$rcpWt,
    category = "rcp", values = "weight",
    draggable = TRUE,
    tooltip =
      "[bold]{valueY}[/]",
    xAxis = list(title = amText(text = "Scenario")),
    yAxis = list(
      title = amText(text = "Weight", color = "maroon"),
      labels = amAxisLabels(fontSize = 10),
      gridLines = amLine(color = "orange", width = 1, opacity = 0.4)
    ),
    yLimits = c(0, 1),
    valueFormatter = "#.##",
    theme = "dataviz")
})
output$gcm_select <- renderAmChart4({
  amBarChart(
    data = session_params$gcmWt,
    category = "gcm", values = "weight",
    draggable = TRUE,
    columnWidth = 80,
    tooltip =
      "[bold]{valueY}[/]",
    xAxis = list(title = amText(text = "GCM"),
                 labels = amAxisLabels(fontSize = 10,rotation = 90)),
    yAxis = list(
      title = amText(text = "Weight", color = "maroon"),
      labels = amAxisLabels(fontSize = 10),
      gridLines = amLine(color = "orange", width = 1, opacity = 0.4)
    ),
    yLimits = c(0, 1),
    valueFormatter = "#.##",
    theme = "dataviz")
})

observeEvent(input$sesh_params,{
  showModal(modalDialog(
    h2("Adjust Session Parameters"),
    h6("Establishment Feasibility Weights"),
    splitLayout(
      numericInput("wt961","1961-1990", value = session_params$estabWt[1], min = 0, max = 1,step = 0.05),
      numericInput("wt991","1991-2020", value = session_params$estabWt[2], min = 0, max = 1,step = 0.05),
      numericInput("wt21","2021-2040", value = session_params$estabWt[3], min = 0, max = 1,step = 0.05)
    ),
    h6("Mid Rotation Weights"),
    splitLayout(
      numericInput("wt41","2041-2060", value = session_params$midWt[1], min = 0, max = 1,step = 0.05),
      numericInput("wt61","2061-2080", value = session_params$midWt[2], min = 0, max = 1,step = 0.05)
    ),
    h6("GCM Weights"),
    p("Click and drag bars to adjust weights"),
    amChart4Output("gcm_select",width = "790px"),
    h6("Scenario Weights"),
    amChart4Output("rcp_select"),
    footer = tagList(
      modalButton("Cancel"),
      actionButton("adj_params","OK!",
                   style = "background-color:#1d8f0e; color: #FFF")
    ),
    size = "l"
    ))
})

observeEvent(input$adj_params,{
  estabWt <- as.numeric(c(input$wt961,input$wt991,input$wt21))
  estabWt <- estabWt/sum(estabWt)
  midWt <- as.numeric(c(input$wt41,input$wt61))
  midWt <- midWt/sum(midWt)
  
  gcm_weight <- as.data.table(input$gcm_select)
  setnames(gcm_weight,c("gcm","weight"))
  rcp_weight <- as.data.table(input$rcp_select)
  setnames(rcp_weight,c("rcp","weight"))
  all_weight <- as.data.table(expand.grid(gcm = gcm_weight$gcm,rcp = rcp_weight$rcp))
  all_weight[gcm_weight,wgcm := i.weight, on = "gcm"]
  all_weight[rcp_weight,wrcp := i.weight, on = "rcp"]
  all_weight[,weight := wgcm*wrcp]
  session_params$estabWt <- estabWt
  session_params$midWt <- midWt; session_params$modelWt <- all_weight;
  session_params$rcpWt <- rcp_weight; session_params$gcmWt <- gcm_weight
  session$sendCustomMessage(type="jsCode", list(code= "$('#generate_results').prop('disabled', false)"))
  removeModal()
})

output$shinyinfo <- function() {
  app_info <- data.table(
    Information = c("Shiny host","Tiles source","Tileserver","Github","Copyright","License"),
    Value = c(system("hostname", intern = TRUE), Sys.getenv("BCGOV_TILESERVER"),
              strsplit(Sys.getenv("BCGOV_TILESERVER"), split = "data")[[1]][1],
              as.character(tags$a(href = "https://github.com/bcgov/CCISS_ShinyApp", "bcgov/CCISS_ShinyApp")),
              paste(format(Sys.Date(), "%Y"), "Province of British Columbia"),
              as.character(tags$a(href = "http://www.apache.org/licenses/LICENSE-2.0", "Apache 2.0 LICENSE")))
  )
  knitr::kable(app_info, format = "html", table.attr = 'class="table table-hover table-centered"', escape = FALSE)
}
```
